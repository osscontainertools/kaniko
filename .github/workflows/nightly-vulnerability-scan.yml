name: Nightly Vulnerability Scan

on:
  schedule:
    # Schedule to run every night at midnight
    - cron: '0 0 * * *'

jobs:
  vulnerability-scan:

    permissions:
      packages: read # pull image from ghcr registry
      issues: write # create issues via gh CLI

    runs-on: ubuntu-latest

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@a90bcbc6539c36a85cdfeb73f7e2f433735f215b # v2.15.0
        with:
          egress-policy: audit

      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false

      - name: Set up Grype
        run: |
          # Install Grype
          curl -sSfL https://raw.githubusercontent.com/anchore/grype/main/install.sh | sh -s -- -b /usr/local/bin

      - name: Get latest commit SHA of Kaniko project
        id: get-commit
        run: |
          LATEST_COMMIT_SHA=$(git rev-parse HEAD)
          echo "Latest commit SHA: $LATEST_COMMIT_SHA"
          echo "::set-output name=sha::$LATEST_COMMIT_SHA"

      - name: Scan the latest CI/CD image
        run: |
          IMAGE_ID="ghcr.io/${{ github.repository }}-dev:${{ steps.get-commit.outputs.sha }}"
          echo "Scanning image $IMAGE_ID"
          grype $IMAGE_ID > grype-output.txt

      - name: Check for vulnerabilities and create an issue
        run: |
          if grep -q 'No vulnerabilities found' grype-output.txt; then
            echo "No vulnerabilities found."
          else
            gh issue create --title "Vulnerabilities Found in Nightly Scan" --body "Vulnerabilities found in the latest image scan. Please check the attached report." --body-file grype-output.txt
          fi
